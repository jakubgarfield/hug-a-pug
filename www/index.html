<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/default.css" />
    <link rel="stylesheet" type="text/css" href="css/menu.css" />
    <link rel="stylesheet" type="text/css" href="css/level.css" />
    <title>Hug a Pug!</title>
</head>
<body>
    <div id="menu" data-bind="visible: showMenu">
        <h1>Hug a Pug!</h1>
        <div id="deviceready" class="blink">
            <ul>
                <li><a data-bind="click: $root.loadNextLevel">Start hugging!!!</a></li>
                <li><a>About</a></li>
            </ul>
        </div>
    </div>

    <div id="level" data-bind="visible: showLevel, attr: { 'class': 'level-' + currentLevel()}">
        <div id="progress">
            <div></div>
        </div>

        <div id="canvas">
            <div class="clearfix">
                <div id="neck"></div>
                <div id="back"></div>
                <div id="tail"></div>
            </div>
        </div>

        <div id="adds">
            <script type="text/javascript" src="http://ad.leadboltads.net/show_app_ad.js?section_id=396571682"></script>
        </div>
    </div>

    <script type="text/javascript" src="phonegap.js"></script>
    <script type="text/javascript" src="js/knockout-2.3.0.js"></script>
    <script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
        document.addEventListener("deviceready", function () {
            function GameViewModel() {
                // Data
                var self = this;
                self.showMenu = ko.observable();
                self.showLevel = ko.observable();
                self.currentLevel = ko.observable();
                self.levels = shuffle([1, 2, 3, 4, 5, 6, 7]);


                // Behaviours
                self.loadNextLevel = function () {
                    self.showMenu(false);
                    self.showLevel(true);
                    self.currentLevel(self.levels.pop());
                    start();
                };


                // Initialization
                self.showLevel(false);
                self.showMenu(true);
                self.currentLevel(0);


                // Functions
                var $neck = $("#neck");
                var $back = $("#back");
                var $tail = $("#tail");
                var $canvas = $("#canvas");
                var $progress = $("#progress > div");

                var bark = new Media(getPhoneGapPath() + "mp3/pug_bark.mp3");
                var score = 0;
                var maxScore = 100;
                var shouldWait = false;

                function shuffle(o) {
                    for (var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
                    return o;
                };

                function resizeCanvas() {
                    var width = $("#canvas").width();
                    $("#canvas").css("height", width / 3 * 4);

                    var body = document.body;
                    var html = document.documentElement;
                    var height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
                    $("#progress").css("height", height * 0.05);
                };

                function getPhoneGapPath() {
                    var path = window.location.pathname;
                    path = path.substr(path, path.length - 10);
                    return 'file://' + path;
                };

                function checkLevel(score) {
                    if (score == 1) {
                        navigator.notification.vibrate(250);
                    } else if (score == 33) {
                        navigator.notification.vibrate(250);
                        bark.play();
                        $active = $back;
                    } else if (score == 66) {
                        navigator.notification.vibrate(250);
                        bark.play();
                        $active = $tail;
                    } else if (score >= maxScore) {
                        navigator.notification.vibrate(500);
                        bark.play();
                        alert('... chro chro chrocht!');
                        self.loadNextLevel();
                    }
                };

                function start() {
                    resizeCanvas();
                    $active = $neck;
                    score = 0;
                    $progress.css("width", score + "%");
                };

                $canvas.bind('touchmove', function (e) {
                    e.preventDefault();

                    if (shouldWait) {
                        return;
                    }

                    var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
                    var elm = $active.offset();
                    var x = touch.pageX - elm.left;
                    var y = touch.pageY - elm.top;
                    if (x < $active.width() && x > 0) {
                        if (y < $active.height() && y > 0) {

                            score++;
                            $progress.css("width", score + "%");
                            checkLevel(score);

                            shouldWait = true;
                            setTimeout(function () { shouldWait = false; }, 100);
                        }
                    }
                });
            };

            ko.applyBindings(new GameViewModel());            
        });
    </script>
</body>

</html>
